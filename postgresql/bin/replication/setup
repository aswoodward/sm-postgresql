#!/bin/sh

if [[ "${USER}" != "${service_user}" ]]
then
  log fail "replication setup may only be run as the service user '${service_user}'"
fi

sm postgresql stop

ssh -o StrictHostKeyChecking=no postgres@${master} \
  "ssh -o StrictHostKeyChecking=no postgres@${HOSTNAME} uname"

files remove "${service_data_path}/wal/*"

psql -U ${service_user} -h ${postgresql_replication_master} -c \
  "SELECT pg_start_backup('$(date)');"

touch "${service_data_path}/wal/00000001.history"

rsync -avPz --delete --exclude .svn --exclude .git --exclude .hg --exclude pg_log \
  --exclude 'recovery.*' --exclude postgresql.conf --exclude pg_xlog \
  ${master}:${service_data_path}/ ${service_data_path}/

find "${service_data_path}/pg_xlog" -type f -exec rm -f {} \;

psql -U ${service_user} -h ${postgresql_replication_master} \
  -c "SELECT pg_stop_backup();"

sm postgresql start

