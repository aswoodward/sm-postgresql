#!/bin/sh

user is root || log error "'postgresql configure system' may only be run as root."

paths create "/etc/postgresql/" "/var/log/postgresql" "/var/run/postgresql" \
  "/var/db/postgresql"

if ! user exists "${service_user}"
then user create system name "${service_user}" home "${service_db_path}" ; fi

template install "postgresql/postgresql.conf" \
  to "${service_data_path}" \
  mode 0644 \
  variables ${postgresql_defaults}

for file in postgresql pg_hba pg_ident recovery
do
  if file is missing "/etc/postgresql/${file}.conf"
  then
    log "Linking ${file}.conf to /etc/postgresql/${file}"

    files link symbolic force \
      from "$service_data_path/${file}.conf" \
      to "/etc/postgresql/${file}.conf"
  fi
done

path chown "$service_user:$service_user" recursively "${service_data_path}"
path chmod 0700 recursively "${service_data_path}"

exit 0
